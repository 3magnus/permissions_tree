<?php
/**
 * @file
 * Code for the ...
 * on demand to save memory consumption during normal site operation.
 */

/**
 * Adds the menu tab for its page.
 */
function permissions_tree_menu() {
    $items['admin/people/permissions/tree'] = array(
      'title' => 'Tree',
      'description' => 'Tree view by role of all enabled permissions.',
      'page callback' => 'permissions_tree_page',
      'access arguments' => array('administer site configuration'),
      'type' => MENU_LOCAL_TASK,
   );  
   return $items;
}


/**
 * Implements the tree view by user.
 */
function permissions_tree_page() {
	// get array of roles names
   $result = db_select('role', 'r')
      ->fields('r', array('rid', 'name'))
      ->execute();
   while ($record = $result->fetchAssoc()) {
   	$roles[$record['rid']] = $record['name'];
   }
   // gather all permissions ordered
   $result = db_select('role_permission', 'rp')
      ->fields('rp', array('rid', 'permission', 'module'))
      ->orderBy('rid', 'ASC')
      ->orderBy('module', 'ASC')
      ->execute();
   $output = array();
   $last = array('rid' => -1, 'permission' => '', 'module' => '');
   $num = 0;
   while ($record = $result->fetchAssoc()) {
   	$num++;
   	if ($record['rid'] != $last['rid']) {
    	   $last['module'] = '';
      	$output[$record['rid']] = array();
      }
      if ($record['module'] != $last['module']) {
      	$modules[] = $record['module'];
       	$output[$record['rid']][$record['module']] = '';
      }
     	$output[$record['rid']][$record['module']] .= _form_html_element('item', $num, $record);
   	$last = $record;
   }
   
   foreach ($output as $rid=>$module) {
      $pagearr[$rid]['fieldset-open'] = array(
         '#markup' => '<fieldset class="collapsible form-wrapper role"><legend><span class="fieldset-legend"><a class="fieldset-title" href="#"><span class="fieldset-legend-prefix element-invisible">Hide</span> '.$roles[$rid].'</a><span class="summary"></span></span></legend><div class="fieldset-wrapper" style="">',
      );
      foreach ($module as $name=>$items) {
         $pagearr[$rid][$name] = array(
            'fieldset' => array(
               '#type' => 'fieldset',
               '#title' => $name,
               '#attributes' => array('class' => array('collapsible', 'collapsed', 'module')),
               'content' => array(
                  '#markup' => $items,
               ),
            ),
         );
      }
      $pagearr[$rid]['fieldset-close'] = array(
         '#markup' => '</div></fieldset>',
      );
   }
   $pagearr['options'] = array(
      '#markup' => '',
      '#attached' => array(
         'js' => array(
            'misc/collapse.js',
            'misc/form.js',
         ),
         'css' => array(
            drupal_get_path('module', 'permissions_tree').'/permissions_tree.css',
         ),
      ),
   );
   return $pagearr;  
}


/**
 * Helper function.
 */
function _form_html_element($element, $number, $row) {
   switch($element) {
   	case 'row':
         $markup = '<tr><td class="module-row" colspan="2">'.$row['module'].'</td></tr>
<tr><td class="checkbox permissions">';
      break;
   	case 'item':
         $markup = ' <div><input disabled="disabled" id="'.$row['module'].'-permission-'.$number.'" name="modules['.$row['module'].']['.$number.'][enable]" value="1" checked="checked" class="form-checkbox" type="checkbox"><label for="'.$row['module'].'-permission-'.$number.'">'.$row['permission'].'</label></div>';
      break;
   }
   return $markup;
}
